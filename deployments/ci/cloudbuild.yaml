steps:
- name: 'gcr.io/cloud-builders/gcloud'
  entrypoint: 'bash'
  args: ['-c', 'gcloud secrets versions access latest --secret="dbt-ci-profiles" > profiles.yml']

- name: 'fishtownanalytics/dbt:1.0.0'
  args: ['deps']

- name: 'fishtownanalytics/dbt:1.0.0'
  args: ['seed']

- name: 'fishtownanalytics/dbt:1.0.0'
  args: ['run', '-x']

- name: 'fishtownanalytics/dbt:1.0.0'
  args: ['test']

timeout: 3600s # 1 hour
options:
  env:
  - 'PULL_REQUEST=$_PR_NUMBER'
  - 'DBT_PROFILES_DIR=/workspace'
