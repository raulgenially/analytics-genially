version: 2

models:
    - name: stg_invoices
      description: Information about invoices and its refunds. This models standarizes and
        sticks together both invoices and refund invoices.
      columns:
        - name: id
          description: Primary key for stg_invoices. This is a surrogate key
            from invoice_id and is_refund.
          tests:
            - unique
            - not_null

        - name: invoice_id
          description: Primary key for invoices.

        - name: description
          description: Description of the type of license purchased.

        - name: payer_email
          description: The email of the person paying the invoice.

        - name: payer_name
          description: The name of the person paying the invoice. It can also be the email.

        - name: payer_cif
          description: The tax ID of the payer.

        - name: payer_address
          description: The payer's address.

        - name: payer_country
          description: The payer's country.

        - name: total
          description: Amount of monetary value paid in the currency
            specified in the currency column.

        - name: total_euro
          description: The equivalent in â‚¬ of the amount specified in total.

        - name: tax_rate
          description: The percentage at which the invoice is taxed.
          tests:
            - not_null:
                where: date(invoiced_at) > '2021-12-21'
            - relationships:
                to: ref('seed_taxkey_taxrate')
                field: tax_rate
                where: date(invoiced_at) > '2021-12-21'
            - dbt_utils.expression_is_true:
                expression: ">= 0"

        - name: tax_key
          description: Tax Idetification key.
          tests:
            - not_null:
                where: date(invoiced_at) > '2021-12-21'
            - relationships:
                to: ref('seed_taxkey_taxrate')
                field: tax_key
                where: date(invoiced_at) > '2021-12-21'

        - name: currency
          description: Currency in which the invoice is paid.

        - name: invoice_number
          description: Unique invoice number.

        - name: payment_platform
          description: Payment platform used to make the payment. Either Braintree,
            Paypal or Stripe.

        - name: reference_invoice_number
          description: Invoice number of the invoice we are refunding.

        - name: is_refund
          description: Whether this invoice is refunding a previous invoice or not.
          tests:
            - not_null

        - name: is_valid_euvat_number
          description: Indicates if 'payer_cif' is validated as Intracomunitary.
          tests:
            - not_null:
                where: date(invoiced_at) > '2021-12-21'

        - name: user_id
          description: Id of the user making the payment.
          tests:
            - relationships:
                to: ref('stg_users')
                field: user_id
                where: invoiced_at > '2018-01-18'

        - name: subscription_id
          description: Id of the subscription in the payment processing platform.

        - name: transaction_id
          description: Id of the transaction in the payment processing platform.

        - name: invoiced_at
          description: Date time at which the invoice was emitted.

        - name: refunded_at
          description: Date time at which this invoice has been refunded.

        - name: originally_invoiced_at
          description: For refunds, date time at which the invoice we are refunding was invoiced.
            For regular invoices, same date time as invoiced_at.
          tests:
            - not_null

      tests:
        - dbt_utils.expression_is_true:
            expression: "refunded_at is null"
            condition: "is_refund = true"

        - dbt_utils.expression_is_true:
            expression: "reference_invoice_number is null"
            condition: "is_refund = false"

        - dbt_utils.expression_is_true:
            severity: warn
            expression: "is_valid_euvat_number = true"
            condition: "tax_key = 'INTRA_21'"
