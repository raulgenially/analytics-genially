version: 2

models:
    - name: stg_geniallys
      columns:
        - name: genially_id
          description: Primary key for geniallys.
          tests:
            - unique
            - not_null

        - name: plan
          description:  "{{ doc('subscription_codes') }}"

        - name: name
          description: Genially name.

        - name: team_name
          description: Name of the team this genially belongs to.

        - name: source
          description: Genially source.
          tests:
            - not_null
            - accepted_values:
                values: "{{ get_genially_source_values() }}"

        - name: category
          description: Genially category.
          tests:
            - not_null

        - name: template_type
          description: Template type that the genially is based on, if any.

        - name: template_name
          description: Name of the template.

        - name: is_published
          description: Whether the genially has been published.

        - name: is_active
          description: Whether the genially is active at the user dashboard.

        - name: is_in_recyclebin
          description: Whether the genially has been sent to the Recycle Bin.

        - name: is_logically_deleted
          description: Whether the genially has been deleted from the Recycle Bin.

        - name: is_deleted
          description: Whether the genially has been physically deleted.

        - name: is_disabled
          description: Indicates whether the genially has been disabled in the context of Teams.
            When a Team is disabled, so do all geniallys within the team.

        - name: is_team_disabled
          description: Indicates whether the team itself this genially belongs to is disabled.

        - name: is_private
          description: Whether the genially can be indexed by search engines.

        - name: is_password_free
          description: Whether the genially has a an access password.

        - name: is_in_social_profile
          description: Whether the genially is shown in user's social profile.

        - name: is_reusable
          description: Whether the genially can be reusable as a template by another user.

        - name: is_inspiration
          description: Whether the genially is shown in inspiration.

        - name: is_visualized_last_90_days
          description: Whether the genially has been visualized within the last 90 days.
          tests:
            - not_null

        - name: is_visualized_last_60_days
          description: Whether the genially has been visualized within the last 60 days.
          tests:
            - not_null

        - name: is_visualized_last_30_days
          description: Whether the genially has been visualized within the last 30 days.
          tests:
            - not_null

        - name: user_id
          description: Foreign key referring to the user creating the genially.

        - name: reused_from_id
          description: Id of the original genially that this one is based on.

        - name: from_template_id
          description: Id of the template used for the creation of the genially.

        - name: team_id
          description: Id of the team this genially is part of.

        - name: space_id
          description: Id of the space this genially is part of.

        - name: team_template_id
          description: Id of the genially as a team template.

        - name: from_team_template_id
          description: Id of the team template used for the creation of the genially.

        - name: modified_at
          description: Modification date.

        - name: created_at
          description: Creation date.

        - name: published_at
          description: Publication date.

        - name: last_view_at
          description: Last time the genially was visualized.

        - name: deleted_at
          description: This refers to the date at which the user moves the Genially to the recycle bin.

        - name: disabled_at
          description: The date at which the genially is disabled because the team is disabled.

        - name: team_created_at
          description: The date the team was created.
          tests:
            - not_null:
                where: "team_id is not null and is_active = true"

      tests:
        - dbt_utils.expression_is_true:
            expression: "is_disabled = true"
            condition: "is_team_disabled = true"

        - dbt_utils.expression_is_true:
            expression: "category != 'Other'"
            condition: "template_type is not null"

        - dbt_utils.expression_is_true:
            expression: "is_visualized_last_60_days = true and is_visualized_last_90_days = true"
            condition: "is_visualized_last_30_days = true"

        - dbt_utils.expression_is_true:
            expression: "is_visualized_last_90_days = true"
            condition: "is_visualized_last_60_days = true"
