version: 2

models:
    - name: billing
      columns:
        - name: id
          description: Primary key for this model.
          tests:
            - unique
            - not_null

        - name: invoice_type
          description: Invoice type (Invoice or Refund).
          tests:
            - not_null
            - accepted_values:
                values: "{{ get_invoice_type_values() }}"

        - name: description
          description: Invoice's description with all product information.
          tests:
            - not_null

        - name: payer_email
          description: The email of the person paying the invoice.
          tests:
            - not_null

        - name: payer_name
          description: The name of the person paying the invoice. It can also be the email.

        - name: payer_cif
          description: The tax ID of the payer.

        - name: payer_address
          description: The payer's address.

        - name: payer_country
          description: The payer's country.
          tests:
            - not_null
            - relationships:
                to: ref('seed_country_codes')
                field: code

        - name: original_amount
          description: Total amount in their original currency.
          tests:
            - not_null

        - name: amount_euro
          description: The equivalent in â‚¬ of the amount specified in original amount.
          tests:
            - not_null

        - name: tax_rate
          description: The percentage at which the invoice is taxed.
          tests:
            - not_null:
                where: date(invoiced_at) > '{{var('invoice_tax_start_date')}}'
            - relationships:
                to: ref('seed_taxkey_taxrate')
                field: tax_rate
                where: date(invoiced_at) > '{{var('invoice_tax_start_date')}}'
            - dbt_utils.expression_is_true:
                expression: ">= 0"

        - name: tax_key
          description: Tax Idetification key.
          tests:
            - not_null:
                where: date(invoiced_at) > '{{var('invoice_tax_start_date')}}'
            - relationships:
                to: ref('seed_taxkey_taxrate')
                field: tax_key
                where: date(invoiced_at) > '{{var('invoice_tax_start_date')}}'

        - name: currency
          description: Original currency of the payment.
          tests:
            - not_null

        - name: subtotal
          description: Paid amount after taxes and converted in eur.
          tests:
            - not_null

        - name: tax_amount
          description: Taxes in eur.
          tests:
            - not_null

        - name: eu
          description: Indicates if the payer resides into European Union (see countries defined in seed_taxkey_taxrate.csv).
          tests:
            - not_null

        - name: iva
          description: Indicates if the payer paid taxes.
          tests:
            - not_null

        - name: payment_platform
          description: Payment platform used to make the payment. Either Braintree,
            Paypal or Stripe.
          tests:
            - not_null

        - name: days
          description: Duration days of the paid subscription.
          test:
            - dbt_utils.expression_is_true:
                  expression: "> 0"

        - name: quantity
          description: Number of subscriptions that have been paid.
          tests:
            - not_null

        - name: product
          description: Type of purchased plan or service and its recurrence.

        - name: recurrence
          description: Indicates if is a annual or monthly plan.
          tests:

        - name: plan
          description: Type of purchased plan or service.
          tests:

        - name: role
          description: Payer role.
          tests:
            - not_null:
                where: "date(invoiced_at) < current_date()"

        - name: sector
          description: Payer sector.
          tests:
            - not_null:
                where: "date(invoiced_at) < current_date()"

        - name: is_valid_euvat_number
          description: Indicates if 'payer_cif' is validated as Intracomunitary.
          tests:
            - not_null:
                where: date(invoiced_at) > '{{var('invoice_tax_start_date')}}' and invoice_type = 'Invoice'

        - name: user_id
          description: Id of the user making the payment.
          tests:
            - not_null
            - relationships:
                to: ref('users')
                field: user_id

        - name: subscription_id
          description: Id of the subscription in the payment processing platform.
            There can be more than one invoice associated with a subscription.
          tests:
            - not_null

        - name: transaction_id
          description: Id of the transaction in the payment processing platform.
            This can be duplicated due to errors in the payment processing platform. There should be a refund invoice fixing this.
          tests:
            - not_null

        - name: invoice_number_id
          description: Unique and financial id for the invoice.
          tests:
            - unique
            - not_null

        - name: reference_invoice_number_id
          description: Invoice number of the invoice we are refunding.
          tests:
            - relationships:
                to: ref('billing')
                field: invoice_number_id

        - name: invoiced_at
          description: Date at which the invoice was created.
          tests:
            - not_null

        - name: originally_invoiced_at
          description: For refunds, date time at which the invoice we are refunding was invoiced.
            For regular invoices, same date time as invoiced_at.
          tests:
            - not_null

        - name: period_start_at
          description: Date at which the paid subscription starts.
          tests:
            - not_null

        - name: period_end_at
          description: Date at which the paid subscription will end.
          tests:
            - not_null
      tests:
        - dbt_utils.expression_is_true:
            expression: "amount_euro = original_amount"
            condition: "currency = 'eur'"

        - dbt_utils.expression_is_true:
            expression: "is_valid_euvat_number is not true"
            condition: "payer_cif is null and invoiced_at > '{{var('invoice_tax_start_date')}}'"
