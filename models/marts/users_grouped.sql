SELECT 
        CASE WHEN dateregister IS null OR dateregister < '2017-01-01' 
        THEN '2017-01-01' ELSE FORMAT_DATE("%Y-%m-%d", DATE(dateregister)) END as dateregister,
        CASE WHEN typesubscription = 1 THEN 'FREE'
        	 WHEN typesubscription = 2 THEN 'Pro'
             WHEN typesubscription = 3 THEN 'Master'
             WHEN typesubscription = 4 THEN 'Edu Pro'
             WHEN typesubscription = 5 THEN 'Edu Team'
             WHEN typesubscription = 6 THEN 'Team'
             WHEN typesubscription = 7 THEN 'Student'
             ELSE 'Other'
        END AS typesubscription,
        CASE WHEN newrole in (1,5,51) then '01-Profesor-OLD'
                WHEN newrole in (11,19,25,31,36,49) then '02-Formador-OLD'
                WHEN newrole in (2,6,12,52) then '03-Alumno-OLD'
                WHEN newrole in (8,14,17,23,29,34,39,43,47) then '04-Disenador-OLD'
                WHEN newrole in (9,15,18,24,30,35,40,44,48) then '05-MkyComuni-OLD'
                WHEN newrole in (41,45) then '06-PeriodistaEditor-OLD'
                WHEN newrole in (3,7,13,20,26,32,37,53) then '07-AdministracionTecnico-OLD'
                WHEN newrole in (21,27) then '08-Ventas-OLD'
                WHEN newrole in (4,10,16,22,28,33,38,42,46,50,54) then '09-Otro-OLD'
				--------------------------------------------
				WHEN newrole in (102,106,110,114,118,122) THEN	  '06-Coordinator/Management'
			    WHEN newrole in (124,131,138,145,152,159,166) THEN '04-Design'
			    WHEN newrole in (127,134,141,148,155,162,169) THEN '07-Finance/Accounting'
			    WHEN newrole in (128,135,142,149,156,163,170) THEN '08-HR'
			    WHEN newrole in (125,132,139,146,153,160,167) THEN '05-Marketing/Communications'
			    WHEN newrole in (103,107,111,115,119,123) THEN '10.1-Other-EDU'
	 			WHEN newrole in (130,137,144,151,158,165,172) THEN '10.2-Other-CORP'
			    WHEN newrole in (129,136,143,150,157,164,171) THEN '09-Sales'
			    WHEN newrole in (101,105,109,113,117,121) THEN 	  '03-Student'
			    WHEN newrole in (100,104,108,112,116,120) THEN 	  '01-Teacher'
			    WHEN newrole in (126,133,140,147,154,161,168) THEN '02-Training'						
                ELSE '99-NoSelected'
        END as agrrole,
		CASE WHEN newrole in (1,5,51) then 'Profesional'
                WHEN newrole in (11,19,25,31,36,49) then 'Profesional'
                WHEN newrole in (2,6,12,52) then 'Student'
                WHEN newrole in (8,14,17,23,29,34,39,43,47) then 'Profesional'
                WHEN newrole in (9,15,18,24,30,35,40,44,48) then 'Profesional'
                WHEN newrole in (41,45) then 'Profesional'
                WHEN newrole in (3,7,13,20,26,32,37,53) then 'Profesional'
                WHEN newrole in (21,27) then 'Profesional'
                WHEN newrole in (4,10,16,22,28,33,38,42,46,50,54) then 'Profesional'
				---------------------------------------------
				WHEN newrole in (102,106,110,114,118,122) THEN	  'Profesional'
			    WHEN newrole in (124,131,138,145,152,159,166) THEN 'Profesional'
			    WHEN newrole in (127,134,141,148,155,162,169) THEN 'Profesional'
			    WHEN newrole in (128,135,142,149,156,163,170) THEN 'Profesional'
			    WHEN newrole in (125,132,139,146,153,160,167) THEN 'Profesional'
			    WHEN newrole in (103,107,111,115,119,123,130,137) THEN 'Profesional'
			    WHEN newrole in (129,136,143,150,157,164,171) THEN 'Profesional'
			    WHEN newrole in (101,105,109,113,117,121) THEN 	  'Student'
			    WHEN newrole in (100,104,108,112,116,120) THEN 	  'Profesional'
			    WHEN newrole in (126,133,140,147,154,161,168) THEN 'Profesional'
                ELSE '99-NoSelected'
        END as rolestudent,
        CASE WHEN newsector = 1  THEN '01-edu-primary-OLD'
             WHEN newsector = 2  THEN '02-edu-higher-OLD'
             WHEN newsector = 3  THEN '03-elearning-OLD'
             WHEN newsector = 4  THEN '04-pyme-OLD'
             WHEN newsector = 5  THEN '05-company-OLD'
             WHEN newsector = 6  THEN '06-public-admin-org-OLD'
             WHEN newsector = 7  THEN '07-freelance-OLD'
             WHEN newsector = 8  THEN '08-media-OLD'
             WHEN newsector = 9  THEN '09-editorial-OLD'
             WHEN newsector = 10 THEN '10-agency-OLD'
             WHEN newsector = 11 THEN '11-edu-second-OLD'
		  ------------------------------------------------
		  	WHEN newrole between 100 AND 103  THEN '01-Elementary School'			
		 	WHEN newrole between 104 AND 107  THEN '02-Middle School'			
		 	WHEN newrole between 108 AND 111  THEN '03-High School'			
		 	WHEN newrole between 112 AND 115  THEN '04-Technical vocational training'			
		 	WHEN newrole between 116 AND 119  THEN '05-University/Graduate School'			
		 	WHEN newrole between 120 AND 123  THEN '06-Other'			
		 	WHEN newrole between 124 AND 130  THEN '07-Agency'			
		 	WHEN newrole between 131 AND 137  THEN '08-Publisher'			
		 	WHEN newrole between 138 AND 144  THEN '09-Private company'			
		 	WHEN newrole between 145 AND 151  THEN '10-Government/Institution'			
		 	WHEN newrole between 152 AND 158  THEN '11-Non-profit/NGO'			
		 	WHEN newrole between 159 AND 165  THEN '12-Freelance'			
		 	WHEN newrole between 166 AND 172  THEN '13-Other'		
            ELSE '99-NoSelected'
        END as agrsect,
		CASE WHEN newsector = 1  THEN 'Education (K12)'
             WHEN newsector = 2  THEN 'University (Higher)'
             WHEN newsector = 3  THEN 'Corporate'
             WHEN newsector = 4  THEN 'Corporate'
             WHEN newsector = 5  THEN 'Corporate'
             WHEN newsector = 6  THEN 'Corporate'
             WHEN newsector = 7  THEN 'Corporate'
             WHEN newsector = 8  THEN 'Corporate'
             WHEN newsector = 9  THEN 'Corporate'
             WHEN newsector = 10 THEN 'Corporate'
             WHEN newsector = 11 THEN 'Education (K12)'
			------------------------------------------------------		
			WHEN newrole between 100 AND 103  THEN 'Education (K12)'			
			WHEN newrole between 104 AND 107  THEN 'Education (K12)'			
			WHEN newrole between 108 AND 111  THEN 'Education (K12)'			
			WHEN newrole between 112 AND 115  THEN 'Corporate'
			WHEN newrole between 116 AND 119  THEN 'University (Higher)'		
			WHEN newrole between 120 AND 123  THEN 'Corporate'	
			WHEN newrole between 124 AND 130  THEN 'Corporate'
			WHEN newrole between 131 AND 137  THEN 'Corporate'
			WHEN newrole between 138 AND 144  THEN 'Corporate'
			WHEN newrole between 145 AND 151  THEN 'Corporate'		
			WHEN newrole between 152 AND 158  THEN 'Corporate'
			WHEN newrole between 159 AND 165  THEN 'Corporate'
			WHEN newrole between 166 AND 172  THEN 'Corporate'
            ELSE '99-NoSelected'
        END as agrsect2,
		CASE WHEN country = 'GB' THEN 'UK' ELSE country END as country,
        count(_id) as users
FROM {{ source('genially', 'users') }} 
GROUP BY 1,2,3,4,5,6,7